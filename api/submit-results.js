// Vercel serverless function to submit user study results to GitHub
// This keeps the GitHub token secure on the server side

export default async function handler(req, res) {
    // Only allow POST requests
    if (req.method !== 'POST') {
        return res.status(405).json({ error: 'Method not allowed' });
    }

    // Get GitHub token from environment variable
    const githubToken = process.env.GITHUB_TOKEN;
    
    if (!githubToken) {
        console.error('GITHUB_TOKEN environment variable is not set');
        return res.status(500).json({ 
            error: 'Server configuration error: GitHub token not configured',
            message: 'Please set GITHUB_TOKEN in Vercel Environment Variables'
        });
    }

    // Get results from request body
    const results = req.body;
    
    if (!results) {
        return res.status(400).json({ error: 'No results data provided' });
    }

    // GitHub API configuration
    const githubOwner = 'paulcho98';
    const githubRepo = 'DeepSink_user_study';

    // Prepare issue data
    const issueData = {
        title: `User Study Results - ${results.participantId}`,
        body: `## User Study Results

**Participant ID:** ${results.participantId}
**Completion Time:** ${new Date(results.timestamp).toLocaleString()}
**Study Duration:** ${Math.round(results.studyDuration / 1000 / 60)} minutes

### Demographics
${Object.entries(results.demographics || {}).map(([key, value]) => `- **${key}:** ${value}`).join('\n')}

### Responses Summary
- **Total Comparison Sets:** ${Object.keys(results.responses || {}).length}
- **Total Videos Evaluated:** ${Object.values(results.responses || {}).reduce((sum, set) => sum + Object.keys(set).length, 0)}

${Object.entries(results.responses || {}).map(([comparisonSet, videos]) => {
    const videoCount = Object.keys(videos).length;
    return `- **${comparisonSet}:** ${videoCount} videos`;
}).join('\n')}

### Detailed Results
\`\`\`json
${JSON.stringify(results, null, 2)}
\`\`\`

---
*This issue was automatically generated by the user study system at ${new Date().toISOString()}*`,
        labels: ['user-study-result', 'data-collection']
    };

    try {
        // Submit to GitHub API
        const response = await fetch(`https://api.github.com/repos/${githubOwner}/${githubRepo}/issues`, {
            method: 'POST',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(issueData)
        });

        if (!response.ok) {
            const errorData = await response.json();
            console.error('GitHub API error:', response.status, errorData);
            return res.status(response.status).json({ 
                error: `GitHub API error: ${response.status}`,
                message: errorData.message || 'Failed to create GitHub issue'
            });
        }

        const issue = await response.json();
        
        return res.status(200).json({ 
            success: true,
            issue: {
                number: issue.number,
                url: issue.html_url
            }
        });

    } catch (error) {
        console.error('Error submitting to GitHub:', error);
        return res.status(500).json({ 
            error: 'Failed to submit results',
            message: error.message || 'Unknown error occurred'
        });
    }
}

